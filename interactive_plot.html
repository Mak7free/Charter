<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Interactive 3D Cell Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <style>
        /* --- LAYOUT & THEME --- */
        body { 
            margin: 0; padding: 0; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex; flex-direction: column; 
            height: 100vh; overflow: hidden; 
            background-color: #f0f2f5;
        }
        
        /* NAVIGATION */
        nav {
            background-color: #1a1a1a;
            color: white;
            padding: 0 20px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            z-index: 100;
            flex-shrink: 0;
        }
        .nav-title { font-weight: 600; font-size: 15px; color: #e0e0e0; letter-spacing: 0.5px; }
        .nav-links a {
            color: #888; text-decoration: none; font-size: 13px;
            margin-left: 15px; padding: 14px 0;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .nav-links a:hover { color: white; }
        .nav-links a.active { color: #3498db; border-bottom-color: #3498db; }

        /* MAIN CONTENT */
        #main-wrapper {
            display: flex; flex-grow: 1;
            height: calc(100vh - 48px);
            overflow: hidden;
        }

        /* SIDEBAR */
        #controls {
            width: 300px;
            background: #ffffff;
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid #e1e4e8;
            display: flex; flex-direction: column; gap: 20px;
            box-shadow: 4px 0 12px rgba(0,0,0,0.03);
            z-index: 50;
        }
        
        #plot-container { flex-grow: 1; position: relative; background: #fff; }
        #graph { width: 100%; height: 100%; }

        /* CONTROLS UI */
        h3 { 
            margin: 0; font-size: 14px; text-transform: uppercase; 
            color: #5f6368; letter-spacing: 1px; border-bottom: 1px solid #eee; 
            padding-bottom: 10px; display: flex; justify-content: space-between; 
            align-items: center;
        }
        
        .control-group { 
            background: #fff; 
        }
        
        .control-header {
            font-size: 13px; font-weight: 700; color: #333;
            margin-bottom: 12px; display: flex; align-items: center;
        }
        .control-header::before {
            content: ''; display: inline-block; width: 4px; height: 14px;
            background: #3498db; margin-right: 8px; border-radius: 2px;
        }

        .input-row { margin-bottom: 12px; }
        label { display: flex; justify-content: space-between; font-size: 12px; color: #555; margin-bottom: 6px; }
        
        input[type=range] { 
            width: 100%; margin: 0; cursor: pointer; height: 4px;
            background: #dfe6e9; border-radius: 2px; appearance: none;
        }
        input[type=range]::-webkit-slider-thumb {
            appearance: none; width: 16px; height: 16px; background: #3498db; 
            border-radius: 50%; cursor: pointer; transition: background 0.15s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        input[type=range]::-webkit-slider-thumb:hover { background: #2980b9; transform: scale(1.1); }
        
        input[type=color] { 
            width: 100%; height: 28px; border: 1px solid #dfe6e9; 
            border-radius: 4px; cursor: pointer; padding: 2px;
        }
        
        span.value-display { font-family: monospace; color: #3498db; font-weight: bold; }
        
        button.action-btn {
            width: 100%; padding: 10px; background: #f1f3f4; color: #333; 
            border: 1px solid #dcdfe6; border-radius: 6px; cursor: pointer; 
            font-size: 13px; font-weight: 600; transition: all 0.2s;
        }
        button.action-btn:hover { background: #e8eaed; border-color: #c0c4cc; }

        button.help-btn {
            background: #3498db; color: white; border: none; 
            border-radius: 12px; width: 20px; height: 20px; 
            font-size: 12px; cursor: pointer;
        }

        /* TOUR OVERLAY */
        #tour-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 2000;
            display: none; justify-content: center; align-items: center;
            backdrop-filter: blur(2px);
        }
        #tour-box {
            background: white; width: 450px; padding: 30px; border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3); position: relative;
        }
        #tour-box h2 { margin-top: 0; color: #2c3e50; font-size: 20px; }
        #tour-box p { color: #555; line-height: 1.6; font-size: 14px; }
        #tour-box ul { padding-left: 20px; color: #444; margin-bottom: 25px; }
        #tour-box li { margin-bottom: 10px; font-size: 13px; }
        #tour-close {
            position: absolute; top: 15px; right: 20px; cursor: pointer;
            font-size: 24px; color: #aaa; transition: color 0.2s;
        }
        #tour-close:hover { color: #333; }
        button.primary-btn {
            background: #3498db; color: white; border: none; width: 100%;
            padding: 12px; border-radius: 6px; font-weight: bold; cursor: pointer;
        }
    </style>
</head>
<body>

    <nav>
        <span class="nav-title">3D Visualization Dashboard</span>
        <div class="nav-links">
            <a href="index.html">Static View 1</a>
            <a href="index(1).html">Static View 2</a>
            <a href="interactive_plot.html" class="active">Interactive Dashboard</a>
        </div>
    </nav>

    <div id="main-wrapper">
        <div id="controls">
            <h3>Controls <button class="help-btn" onclick="toggleTour()">?</button></h3>

            <div class="control-group">
                <div class="control-header">Sphere Appearance</div>
                
                <div class="input-row">
                    <label>Transparency: <span id="val-sphere-opacity" class="value-display">0.1</span></label>
                    <input type="range" id="sphere-opacity" min="0" max="1" step="0.05" value="0.1">
                </div>
                
                <div class="input-row">
                    <label>Membrane Color</label>
                    <input type="color" id="sphere-color" value="#FFC8DC">
                </div>
                
                <div class="input-row">
                    <label>Sphere Size (Zoom): <span id="val-sphere-scale" class="value-display">1.0</span></label>
                    <input type="range" id="sphere-scale" min="0.5" max="1.5" step="0.05" value="1.0">
                </div>
            </div>

            <div class="control-group">
                <div class="control-header">Data Points</div>
                
                <div class="input-row">
                    <label>Pair Marker Size: <span id="val-pair-size" class="value-display">8</span></label>
                    <input type="range" id="pair-size" min="2" max="30" step="1" value="8">
                </div>

                <div class="input-row">
                    <label>Single Points Size: <span id="val-single-size" class="value-display">5</span></label>
                    <input type="range" id="single-size" min="1" max="20" step="1" value="5">
                </div>
            </div>

            <div class="control-group">
                <div class="control-header">Layout & Labels</div>
                
                <div class="input-row">
                    <label>Label Expansion: <span id="val-label-dist" class="value-display">1.0</span></label>
                    <input type="range" id="label-dist" min="0.8" max="2.0" step="0.05" value="1.0">
                </div>

                <div class="input-row">
                    <label>Font Size: <span id="val-font-size" class="value-display">11</span></label>
                    <input type="range" id="font-size" min="8" max="24" step="1" value="11">
                </div>
                
                <div class="input-row">
                    <label>Axis Text Size: <span id="val-tick-size" class="value-display">20</span></label>
                    <input type="range" id="tick-size" min="10" max="40" step="1" value="20">
                </div>
            </div>

            <button class="action-btn" onclick="resetView()">Reset Camera View</button>
        </div>

        <div id="plot-container">
            <div id="graph"></div>
        </div>
    </div>

    <div id="tour-overlay" onclick="toggleTour()">
        <div id="tour-box" onclick="event.stopPropagation()">
            <span id="tour-close" onclick="toggleTour()">&times;</span>
            <h2>Dashboard Guide</h2>
            <p>This interactive tool allows you to customize the 3D visualization for presentations or analysis.</p>
            <ul>
                <li><strong>Sphere Appearance:</strong> Adjust the "Cell Membrane" to make it visible or subtle. "Sphere Size" scales the reference boundary.</li>
                <li><strong>Data Points:</strong> If markers are overlapping, reduce the "Pair Marker Size".</li>
                <li><strong>Label Expansion:</strong> The most important control. Use this to push text labels further out from the center to prevent clutter.</li>
                <li><strong>Reset Camera:</strong> Click this if you get lost while rotating the 3D view.</li>
            </ul>
            <button class="primary-btn" onclick="toggleTour()">Got it</button>
        </div>
    </div>

    <script>
        // --- 1. DATA DEFINITION ---
        const rawData = {
            centers: [
                {x: 0.4955, y: 1.8880, z: -2.1130}, 
                {x: 1.4530, y: -4.5535, z: -0.7318}, 
                {x: 0.8735, y: 2.2900, z: -1.8457}, 
                {x: 4.2345, y: 5.5730, z: 1.4450},  
                {x: 0.9230, y: -1.7975, z: 0.4948},  
                {x: 1.4465, y: 1.9470, z: -1.9415},  
                {x: -7.3545, y: -0.3885, z: 1.5013}, 
                {x: 1.7735, y: -3.5050, z: -0.2461}  
            ],
            vectors: [
                 {x: -0.638, y: 0.091, z: -0.697},
                 {x: -0.199, y: -0.988, z: -0.112},
                 {x: -0.063, y: 0.999, z: -0.223},
                 {x: 0.099, y: 0.657, z: 0.781},
                 {x: 0.492, y: -0.564, z: 0.707},
                 {x: 0.903, y: 0.489, z: 0.037},
                 {x: -0.801, y: -0.111, z: 0.622},
                 {x: 0.780, y: -0.507, z: -0.405}
            ],
            baseRadius: 10.4 
        };

        // --- 2. INITIALIZATION ---
        // Indices for efficient batch updating
        const SPHERE_IDX = 0;
        const SINGLE_IDX = 1;
        // Markers are at even indices starting from 2: [2, 4, 6, 8, 10, 12, 14, 16]
        const MARKER_INDICES = rawData.centers.map((_, i) => 2 + (i * 2));
        // Lines are at odd indices starting from 3: [3, 5, 7, 9, 11, 13, 15, 17]
        const LINE_INDICES = rawData.centers.map((_, i) => 3 + (i * 2));

        var data = [
            {
                type: "mesh3d", alphahull: 0, color: "rgb(255, 200, 220)", opacity: 0.1,
                name: "Cell Membrane", hoverinfo: "skip", x: [], y: [], z: []
            },
            {
                type: "scatter3d", mode: "markers", name: "Single Points",
                marker: { color: "#666666", opacity: 0.5, size: 5, symbol: "circle" },
                x: [0.37, 4.39, -1.32, -0.20, -3.47, -1.60, 2.80, 3.37, -5.37, -4.25, -2.41],
                y: [6.75, 8.24, -2.10, -3.27, 1.07, 1.25, 3.30, -2.22, -3.99, -2.94, -9.00],
                z: [1.30, 1.49, 1.13, 0.71, -1.09, -0.77, -0.35, 0.53, 1.50, 0.96, 1.46]
            }
        ];

        const colors = ['#E6194B', '#3CB44B', '#4363D8', '#F58231', '#911EB4', '#42D4F4', '#F032E6', '#bfef45'];
        const pairsData = [
            {p1: [0.52, 1.88, -2.15], p2: [0.48, 1.89, -2.07], dist: "0.09"},
            {p1: [1.31, -4.55, -0.72], p2: [1.60, -4.56, -0.74], dist: "0.29"},
            {p1: [0.64, 2.25, -1.98], p2: [1.10, 2.32, -1.71], dist: "0.54"},
            {p1: [3.90, 5.69, 1.39], p2: [4.57, 5.46, 1.50], dist: "0.72"},
            {p1: [1.05, -1.46, 0.36], p2: [0.80, -2.13, 0.63], dist: "0.76"},
            {p1: [1.03, 1.82, -1.97], p2: [1.86, 2.07, -1.91], dist: "0.87"},
            {p1: [-7.03, -0.86, 1.50], p2: [-7.68, 0.08, 1.50], dist: "1.13"},
            {p1: [1.69, -4.09, -0.55], p2: [1.86, -2.92, 0.06], dist: "1.33"}
        ];

        pairsData.forEach((p, i) => {
            // Marker Trace
            data.push({
                type: "scatter3d", mode: "markers+lines",
                name: `Pair ${i+1} (${p.dist}µm)`,
                marker: { size: 8, color: colors[i], symbol: i < 4 ? 'square' : 'circle' },
                line: { width: 4, color: colors[i] },
                x: [p.p1[0], p.p2[0]], y: [p.p1[1], p.p2[1]], z: [p.p1[2], p.p2[2]]
            });
            // Line Stem Trace
            data.push({
                type: "scatter3d", mode: "lines", showlegend: false,
                line: { color: "gray", width: 2 }, hoverinfo: "skip",
                x: [0, 0], y: [0, 0], z: [0, 0] 
            });
        });

        var layout = {
            margin: { l: 0, r: 0, b: 0, t: 0 },
            paper_bgcolor: "white",
            showlegend: true,
            legend: { x: 0.85, y: 0.9, bgcolor: "rgba(255,255,255,0.8)", bordercolor: "black", borderwidth: 1 },
            scene: {
                aspectmode: "cube",
                xaxis: { title: { text: "<b>X (µm)</b>", font: { size: 24, family: "Arial" } }, tickfont: { size: 20 }, range: [-15, 15] },
                yaxis: { title: { text: "<b>Y (µm)</b>", font: { size: 24, family: "Arial" } }, tickfont: { size: 20 }, range: [-15, 15] },
                zaxis: { title: { text: "<b>Z (µm)</b>", font: { size: 24, family: "Arial" } }, tickfont: { size: 20 }, range: [-15, 15] },
                annotations: [] 
            }
        };

        // Generate Sphere Geometry
        function generateSphere(radius) {
            const u = [], v = [];
            for(let i=0; i<=20; i++) u.push(i * Math.PI / 20);
            for(let j=0; j<=40; j++) v.push(j * 2 * Math.PI / 40);
            
            const x=[], y=[], z=[];
            for(let i=0; i<u.length; i++) {
                for(let j=0; j<v.length; j++) {
                    x.push(radius * Math.sin(u[i]) * Math.cos(v[j]));
                    y.push(radius * Math.sin(u[i]) * Math.sin(v[j]));
                    z.push(radius * Math.cos(u[i]));
                }
            }
            return {x, y, z};
        }

        const initialSphere = generateSphere(rawData.baseRadius);
        data[0].x = initialSphere.x; data[0].y = initialSphere.y; data[0].z = initialSphere.z;

        Plotly.newPlot('graph', data, layout, {responsive: true});

        // --- 3. BATCHED UPDATE LOGIC (The Fix) ---
        // We use a 'debounce' to prevent firing calculations on every single pixel of mouse movement
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        function updateGraphLogic() {
            // 1. GATHER INPUTS
            const sphereOpacity = parseFloat(document.getElementById('sphere-opacity').value);
            const sphereColor = document.getElementById('sphere-color').value;
            const sphereScale = parseFloat(document.getElementById('sphere-scale').value);
            const pairSize = parseInt(document.getElementById('pair-size').value);
            const singleSize = parseInt(document.getElementById('single-size').value);
            const labelDistMult = parseFloat(document.getElementById('label-dist').value);
            const fontSize = parseInt(document.getElementById('font-size').value);
            const tickSize = parseInt(document.getElementById('tick-size').value);

            // 2. PRE-CALCULATE ARRAYS
            const newRadius = rawData.baseRadius * sphereScale;
            const sphereMesh = generateSphere(newRadius);
            const currentLabelRadius = newRadius * 1.35 * labelDistMult; 

            // Prepare arrays for Line Updates
            const lineX = [], lineY = [], lineZ = [];
            const newAnnotations = [];

            rawData.centers.forEach((center, i) => {
                const vec = rawData.vectors[i];
                const lx = vec.x * currentLabelRadius;
                const ly = vec.y * currentLabelRadius;
                const lz = vec.z * currentLabelRadius;

                // Push coordinate arrays for this line
                lineX.push([center.x, lx]);
                lineY.push([center.y, ly]);
                lineZ.push([center.z, lz]);

                // Create annotation object
                newAnnotations.push({
                    x: lx, y: ly, z: lz,
                    text: `Pair ${i+1}`,
                    ax: 0, ay: 0,
                    font: { size: fontSize, color: "black", family: "Arial" },
                    bgcolor: "rgba(255, 255, 255, 0.7)",
                    bordercolor: "#444", borderpad: 3, borderwidth: 1,
                    captureevents: true
                });
            });

            // 3. EXECUTE BATCHED UPDATES (Minimizing Plotly Calls)
            
            // A. Update Sphere
            Plotly.restyle('graph', {
                'opacity': sphereOpacity,
                'color': sphereColor,
                'x': [sphereMesh.x], 'y': [sphereMesh.y], 'z': [sphereMesh.z]
            }, [SPHERE_IDX]);

            // B. Update Single Points
            Plotly.restyle('graph', { 'marker.size': singleSize }, [SINGLE_IDX]);

            // C. Update All Pair Markers (Batch update size only)
            Plotly.restyle('graph', { 'marker.size': pairSize }, MARKER_INDICES);

            // D. Update All Connector Lines (Batch update geometry)
            Plotly.restyle('graph', { 
                'x': lineX, 
                'y': lineY, 
                'z': lineZ 
            }, LINE_INDICES);

            // E. Update Layout (Annotations & Axes)
            Plotly.relayout('graph', {
                'scene.annotations': newAnnotations,
                'scene.xaxis.tickfont.size': tickSize,
                'scene.yaxis.tickfont.size': tickSize,
                'scene.zaxis.tickfont.size': tickSize,
                // Scales Titles relative to ticks (approx logic)
                'scene.xaxis.title.font.size': tickSize + 4,
                'scene.yaxis.title.font.size': tickSize + 4,
                'scene.zaxis.title.font.size': tickSize + 4,
            });
        }

        const debouncedUpdate = debounce(updateGraphLogic, 50);

        function handleInput(e) {
            // Update the text number immediately for responsiveness
            const spanId = 'val-' + e.target.id;
            const span = document.getElementById(spanId);
            if(span) span.textContent = e.target.value;
            // Trigger the heavy graph update
            debouncedUpdate();
        }

        // Listeners
        document.querySelectorAll('input').forEach(input => {
            input.addEventListener('input', handleInput);
        });

        function resetView() {
            Plotly.relayout('graph', {'scene.camera': null});
        }

        function toggleTour() {
            const modal = document.getElementById('tour-overlay');
            modal.style.display = (modal.style.display === 'flex') ? 'none' : 'flex';
        }

        // Initial check to toggle tour if needed, currently off by default
        // toggleTour();
    </script>
</body>
</html>
